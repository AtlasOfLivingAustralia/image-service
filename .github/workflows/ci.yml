name: CI Build and Deploy

on:
  push:
    branches:
      # Corresponds to 'branches: only:'
      - master
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    # Runs on pull requests to these branches
    branches:
      - master
      - develop

env:
  # Corresponds to 'env: global:'
  JAVA_TOOL_OPTIONS: -Dhttps.protocols=TLSv1.2
  GRADLE_OPTS_BASE: -Dgrails.env=travis
  TRAVIS_DEPLOY_USERNAME: ${{ secrets.TRAVIS_DEPLOY_USERNAME }}
  TRAVIS_DEPLOY_PASSWORD: ${{ secrets.TRAVIS_DEPLOY_PASSWORD }}

jobs:
  build:
    # GitHub Actions defaults to the latest Ubuntu runner (equivalent to a recent 'dist: noble')
    runs-on: ubuntu-latest

    # Set up PostgreSQL service directly in the runner
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: runner
          POSTGRES_PASSWORD: ''
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Caching Configuration (Replaces 'cache: directories:' and 'before_cache:') ---

      - name: Set up Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.m2
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # --- Environment Setup (Replaces 'language:', 'jdk:', and 'before_install:') ---

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Start ElasticSearch with Docker Compose
        run: docker compose -f elastic.yml up -d

      - name: Wait for services to be ready
        run: |
          # Simple check to wait for the ElasticSearch service to be ready
          # You might need a more robust check based on your application's requirements
          echo "Waiting for ElasticSearch..."
          sleep 10 

      # --- Install/Build Phase (Replaces 'install:' and 'travis_wait') ---

      - name: Clean build
        # We don't need 'travis_wait 30' as GitHub Actions handles timeouts differently.
        # Run with the base environment option.
        run: ./gradlew clean
        env:
          GRADLE_OPTS: ${{ env.GRADLE_OPTS_BASE }}

      - name: Assemble project
        run: ./gradlew assemble
        env:
          GRADLE_OPTS: ${{ env.GRADLE_OPTS_BASE }}

      - name: Test project
        run: ./gradlew check
        env:
          GRADLE_OPTS: ${{ env.GRADLE_OPTS_BASE }}

      # --- Deployment/Success Phase (Replaces 'after_success:') ---

      - name: Publish (on successful master/develop/feature/hotfix push, not PR)
        if: github.event_name == 'push' && success()
        run: ./gradlew publish --stacktrace
        env:
          GRADLE_OPTS: -Dgrails.env=production

      # --- Cleanup Phase (Replaces 'after_script:') ---

      - name: Stop Docker Compose services
        if: always() # Run even if previous steps fail
        run: docker compose -f elastic.yml down

      # --- Failure Reporting (Replaces 'after_failure:') ---

      - name: Print integration test results on failure
        if: failure()
        run: cat build/test-results/integrationTest/*
        # Note: The path is relative to the workspace root, adjusting from the Travis path.

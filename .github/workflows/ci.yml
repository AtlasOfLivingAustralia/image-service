name: CI Build and Deploy

on:
  push:
    branches:
      # Corresponds to 'branches: only:'
      - master
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    # Runs on pull requests to these branches
    branches:
      - master
      - develop

env:
  # Corresponds to 'env: global:'
  JAVA_TOOL_OPTIONS: -Dhttps.protocols=TLSv1.2
  GRADLE_OPTS_BASE: -Dgrails.env=travis
  TRAVIS_DEPLOY_USERNAME: ${{ secrets.TRAVIS_DEPLOY_USERNAME }}
  TRAVIS_DEPLOY_PASSWORD: ${{ secrets.TRAVIS_DEPLOY_PASSWORD }}

jobs:
  build:
    # GitHub Actions defaults to the latest Ubuntu runner (equivalent to a recent 'dist: noble')
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # --- Environment Setup (Replaces 'language:', 'jdk:', and 'before_install:') ---

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    # --- Setup Gradle action, (includes replacment for 'cache: directories:' and 'before_cache:') ---

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      # uses: gradle/actions/setup-gradle@v5.0.0 # use this for act

    - name: Start ElasticSearch with Docker Compose
      run: docker compose -f elastic-dc2.yml up -d

    - name: Wait for services to be ready
      run: |
        # Simple check to wait for the ElasticSearch service to be ready
        # You might need a more robust check based on your application's requirements
        echo "Waiting for ElasticSearch..."
        sleep 10 

      # --- Install/Build Phase (Replaces 'install:' and 'travis_wait') ---

    - name: Clean build
      # We don't need 'travis_wait 30' as GitHub Actions handles timeouts differently.
      # Run with the base environment option.
      run: ./gradlew clean
      env:
        GRADLE_OPTS: ${{ env.GRADLE_OPTS_BASE }}

    - name: Assemble project
      run: ./gradlew assemble
      env:
        GRADLE_OPTS: ${{ env.GRADLE_OPTS_BASE }}

    - name: Test project
      run: ./gradlew check
      env:
        GRADLE_OPTS: ${{ env.GRADLE_OPTS_BASE }}

    # --- Failure Reporting (Replaces 'after_failure:') ---

    - name: Publish Unit Test Report
      id: unit-test-report
      uses: mikepenz/action-junit-report@v5
      if: failure()
      with:
        report_paths: '**/build/reports/tests/test/*'

    - name: Publish Integration Test Report
      id: integration-test-report
      uses: mikepenz/action-junit-report@v5
      if: failure()
      with:
        report_paths: '**/build/test-results/integrationTest/*'

      # --- Deployment/Success Phase (Replaces 'after_success:') ---

    - name: Publish (on successful master/develop/feature/hotfix push, not PR)
      if: github.event_name == 'push' && success()
      run: ./gradlew publish --stacktrace
      env:
        GRADLE_OPTS: -Dgrails.env=production

      # --- Cleanup Phase (Replaces 'after_script:') ---

    - name: Stop Docker Compose services
      if: always() # Run even if previous steps fail
      run: docker compose -f elastic.yml down
